---
title: "PracTools Project"
author: "Stacey Frank&Chendi Zhao"
date: "3/18/2022"
output: html_document
---

```{r setup, include=FALSE}
library(PracTools)
library(tidyverse)
library(sampling)
library(tidycensus)
library(readxl)
library(tigris)
library(leaflet)
library(glue)
library(sf)

options(tigris_class ="sf")
options(tigris_use_cache =T)

set.seed(-741881304)
```

#dat

```{r}
#census_api_key("8d57522614835c99dcce8b73512ec3760320d47d", install = TRUE)
Tract<- read_excel("C:/Users/cd_zh/Desktop/745/PrinceGeorgeMD_Tract.xlsx")
BG<- read_excel("C:/Users/cd_zh/Desktop/745/PrinceGeorgeMD_Blockgroup.xlsx")
```

# 3. Sampling Design 

Objectives: 
 1.self-weighting 
 2.equal workload in each PSU

 Tracts as PSU; Block groups as SSU; Persons as elements.
 Domains(d):Age Groups 
 
##Population Information
```{r}
N=863420

N_Male=414161
N_Female=449259

N_Male_d1=172607
N_Male_d2=102456
N_Male_d3=34029
N_Male_target=N_Male_d1+N_Male_d2+N_Male_d3
N_Female_d1=178118
N_Female_d2=122727
N_Female_d3=47484
N_Female_target=N_Female_d1+N_Female_d2+N_Female_d3

N_d1=N_Male_d1+N_Female_d1
N_d2=N_Male_d2+N_Female_d2
N_d3=N_Male_d3+N_Female_d3

N_target=N_d1+N_d2+N_d3


N_target
N_Male_target;N_Female_target
N_d1;N_d2;N_d3
```

## Textbook 10.5
The purposes of the composite MOS are to get:
1. Self-weighting samples from each of several domains
2. Equal workload in each PSU, i.e., same total sample size in each PSU (across all domains)
3. PSU selection probabilities that give “credit” for containing domains that are relatively rare in the population.

```{r sampling rate&workload}
#Sample size
n=300
n_d=100
#Sample tracts
m=15
#Sample blcokgroups/tract
n_bar=1

#Expected response rate
rr_1=0.6
rr_2=0.7
rr_3=0.85

#Expected Sample size after taking response rate into account
n_d1=ceiling(n_d/rr_1)
n_d2=ceiling(n_d/rr_2)
n_d3=ceiling(n_d/rr_3)

new_n=n_d1+n_d2+n_d3
new_n
#Sampling rate
##Overall
f=new_n/N_target
##For units in each domain
fd_1=n_d1/N_d1
fd_2=n_d1/N_d2
fd_3=n_d1/N_d3

f;fd_1;fd_2;fd_3

# same n(respondents) in each age group
q=new_n/(m*n_bar)
q

### Excel Table1
```

##Calculate composite MOS for Tract and BG (Textbook 10.5)
### See Excel "MOS Tract" & "MOS BG"

### Note: The notations in the formulas are not 100% correct, should refer to Textbook P285 ("More Than Two Stages of Sampling")

The composite MOS for PSU(Tract) is defined to be (10.1)
$S_i=\sum_{D}^{d=1} f_dN_{ij}(d)\\$
The total composite MOS for each PSU(Tract)can be written as 
$S=\sum_{i\epsilon U}\sum_{D}^{d=1} f_dN_{i}(d)\\$
=$\sum_{D}^{d=1} f_d\sum_{i\epsilon U}N_{i}(d)\\$
The selection probability within each PSU(Tract)
$\pi_i=q*({f_d/S_i})$
The desired sample of each PSU(Tract)can be calculated by
$\pi_i*N_i$


The composite MOS for SSU (BG) is defined to be (10.1)
$S_i=\sum_{D}^{d=1} f_dN_{ij}(d)\\$
The total composite MOS for each SSU (BG) can be written as 
$S_{i+}=\sum_{i\epsilon U}\sum_{D}^{d=1} f_dN_{i+}(d)\\$
=$\sum_{D}^{d=1} f_d\sum_{i\epsilon U}N_{i+}(d)\\$
The selection probability within each SSU (BG)
$\pi_i\pi_{j|i}=q*({S_{i+}*S_{ij})/({S_{++}*S_{i+}}})$
The desired sample of each SSU (BG) can be calculated by
$\pi_i\pi_{j|i}*N_{ij}$

##Check Feasibility of each Tract and BG (Textbook P286)
$f(d)\leq S(i)/\bar{n}$

There is one tract and several BGs do not meet the criteria above--Need to check the map and decide whether to drop or combine the BGs
(the unfeasible tract actually contains unfeasible BGs, so it might be okay to just deal with the issue in BG-level)

##Then, recalculate the selection probability and desired sample size in each PSU and SSU; Construct weights

##Quality Control Checks (Textbook 11.1)
$q^*_{ij}(d)\leq Q_{ij}(d)$
$\bar{\bar{q}}\leq Q_{ij}$ for each SSU
$\bar{n}\bar{\bar{q}}\leq Q_i$ for each PSU
$\pi_i$,$\pi_{j|i}$,$\pi_{k|ij}$ less or equal to 1

# 4.Sample Selction
# 5.Anticipated Precision (???)

# 6.General explanation of variance estimation & Additional considerations
# 7.Maps
# Create maps of PG County Tracts and Selected Block Groups

```{r, echo = FALSE, message = FALSE, results = "hide"}

## PG County Tract Shapefile

pg_trt <- tracts(state="MD", county="Prince", year=2010)

pg_trt_trans <- st_transform(pg_trt, 
                             "+proj=longlat +datum=WGS84")

pg_trt_trans[1:2,]

```

```{r, echo = FALSE, message = FALSE}
## PG County Blockgroup Shapefile

pg_bg <- block_groups(state="MD", county="Prince", year=2010)

pg_bg_trans <- st_transform(pg_bg, 
                             "+proj=longlat +datum=WGS84")

```

## Map of Prince George's County, MD Tracts and Block Groups

```{r, echo = FALSE}
leaflet() %>%
  addTiles() %>%
  addPolygons(data=pg_trt_trans,
              popup = ~NAMELSAD10,
              fillOpacity = 0, 
              fillColor= "snow") %>%
  addPolygons(data=pg_bg_trans,
              popup = ~NAMELSAD10,
              color = "black",
              weight = 1,
              opacity= 1,
              smoothFactor = 1,
              fillOpacity = 0,
              fillColor= "snow",
              label = ~paste0("Tract: ", TRACTCE10, " Block Group: ", NAMELSAD10)) 
```

## Map of Sampled Block Groups in Prince George's County, MD

```{r, echo = FALSE}
#Need to replace in this line with a list of all the block groups that were actually selected
pg_bg_sample<-pg_bg_trans [1:15,]

leaflet() %>%
  addTiles() %>%
  addPolygons(data=pg_trt_trans,
              popup = ~NAMELSAD10,
              fillOpacity = 0, 
              fillColor= "snow") %>%
  addPolygons(data=pg_bg_sample,
              color = "red",
              weight = 3,
              popup = ~NAMELSAD10,
              label = ~paste0("Tract: ", TRACTCE10, " Block Group: ", NAMELSAD10))
```
