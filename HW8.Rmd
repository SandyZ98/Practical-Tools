---
title: "SURVMETH 745 HW8"
author: "Stacey Frank & Chendi Zhao"
date: "4/4/2022"
output:
  word_document: default
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
library(PracTools)
library(tidyverse)
library(survey)
library(ggplot2)
source("http://pcwww.liv.ac.uk/~william/R/crosstab.r")
```


```{r include=FALSE}
dat<-read.csv("nhis2014_paradata.csv")
names(dat)
dim(dat)

#The outcome variable "CTSTAT3" provides the number of contact attempts that resulted in noncontact. "WTIA_PD" is the base weights.
```

# Q1.
```{r include=FALSE}
table(dat$OUTCOME1,exclude = NULL)
dat$OUTCOME<-case_when(dat$OUTCOME1==201|dat$OUTCOME1==203~"Response",
                       dat$OUTCOME1==213|dat$OUTCOME1==215|dat$OUTCOME1==217|dat$OUTCOME1==218|dat$OUTCOME1==219~"Nonresponse",
                       dat$OUTCOME1==299~"Ineligible",
                       dat$OUTCOME1==216~"Unknown Eligible",
                       TRUE~as.character(NA)
                       )
```


```{r echo = FALSE}
crosstab(dat, row.vars = "OUTCOME1", col.vars = "OUTCOME", type = "f",addmargins = T)
```

# Q2.
$e=\frac{n-(U+NE)}{n-U}=\frac{I+P+R+NC+O}{I+P+R+NC+NE+O}$

$RR3=I/((I+P)+(R+NC+O)+eU)$
```{r include=FALSE}
# I is number of completed cases; U is the number of unknown eligible cases
# Assume that the share of cases of unknown eligibility who would have been eligible is the same as the share among the cases whose eligibility was determined
```

```{r results = 'hide'}
e=(13115+45821)/(70790-3001)
RR3<-35823/(45821+13115+e*3001)
RR3
```
The response rate for these data, as calculated by the AAPOR Response Rate 3 formula, is 58.2%.

# Q3.
In each adjustment class b:

The unknown eligibility adjustment for sample units $s_{b,KN}$ is 
$a_{1b}= \sum_{i\in{sb}}d_{0i}/\sum_{i\in{sb,KN}}d_{0i}$, where $d_{0i}$ is the base weight.

The final adjusted weight is $a_{1b}*d_{0i}$
```{r message = FALSE}
# Observe distribution of data for CNREG by OUTCOME groupings
table(dat$CENREG,dat$OUTCOME,exclude = NULL)

# Group data by CENREG and OUTCOME; sum weights within those groupings
dat2<-dat %>%
  group_by(CENREG, OUTCOME) %>%
  summarise(base=sum(WTIA_PD))

# Calculate a1b for each of the 4 classes
w1=sum(dat2$base[1:4])/sum(dat2$base[1:3])
w2=sum(dat2$base[5:8])/sum(dat2$base[5:7])
w3=sum(dat2$base[9:12])/sum(dat2$base[9:11])
w4=sum(dat2$base[13:16])/sum(dat2$base[13:15])
rbind(w1,w2,w3,w4)

dat3<-dat %>%
  group_by(CENREG, OUTCOME) %>%
  summarise(base=WTIA_PD,
            CTSTAT3)

# Calculate unknown eligibility adjusted weights
dat3$WT_Eligible<-case_when(
  dat3$CENREG==1&!dat3$OUTCOME=="Unknown Eligible"~dat3$base*w1,
  dat3$CENREG==2&!dat3$OUTCOME=="Unknown Eligible"~dat3$base*w2,
  dat3$CENREG==3&!dat3$OUTCOME=="Unknown Eligible"~dat3$base*w3,
  dat3$CENREG==4&!dat3$OUTCOME=="Unknown Eligible"~dat3$base*w4,
  dat3$OUTCOME=="Unknown Eligible"~dat3$base*0,
  TRUE~as.numeric(NA))

#Drop unknown eligibility cases from data frame
dat4<-dat3%>%filter(!OUTCOME=="Unknown Eligible")
```

This is a scatterplot of the base weights and the unknown eligibility adjusted weights, shown by census region, the variable used for the weighting class:

```{r include = FALSE}
dat4%>%ggplot(aes(base,WT_Eligible,color=factor(CENREG)))+
  geom_point(alpha=0.2, size=2) +
  facet_grid(vars(OUTCOME),vars(CENREG))+
  labs(x="Base weight",
   y="Unknown Eligibility Adjusted Weight",
   color="Census Region of Residence")

```

# Q4.
```{r warning = FALSE}
dat5<-dat%>%filter(OUTCOME=="Nonresponse")

unwt.mean=mean(dat5$CTSTAT3,na.rm=T)

wt.dsn <- svydesign(ids = ~PSU_P, strata = ~STRAT_P, weights = ~WTIA_PD, data = dat5, nest = TRUE)
wt.mean <- svymean(~CTSTAT3, wt.dsn, na.rm=TRUE)

unwt.mean;wt.mean

dat5%>%ggplot(aes(dat5$CTSTAT3,dat5$WTIA_PD))+
  geom_point()+
    labs(x="Number of contact attempts that resulted in noncontact",
   y="Base weight")

```

The mean of CTSTAT3 among nonrespondents without base weights is 4.86, while after using base weight it is 4.91. The mean value of CTSTAT3 is inflated slightly when using the base weights because, as can be seen from the scatterplot of baseweight and CTSTAT3 above, the cases with base weights above 10,000 mostly required more than 5 contact attempts before they were classified as noncontacts. The large base weights for those cases are driving the weighted mean value to be highter. 

However, it should be noted that the NHIS description file says "not every analysis involving the paradata File will entail making population inferences. For example, a data user may want to describe the level of effort (number of contact attempts) expended by NHIS interviewers across a wide range of final case dispositions (complete interview, partial interview, noncontact, refusal, etc.). Use of WTIA_PD would not be necessary in this situation." The number of contact attempts it took to reach a house is not intrinsically related to that house's selection probability, so it doesn't really make sense to use the weights when analyzing this variable. 

# Q5a. 

```{r results = 'hide'}
#Create binary indicator for response
dat$resp <- case_when(dat$OUTCOME1==201 ~ 1,
                       TRUE ~ 0
                       )

#Design for weighted model
wt.dsn2 <- svydesign(ids = ~PSU_P, strata = ~STRAT_P, weights = ~WTIA_PD, data = dat, nest = TRUE)

#Weighted binary propensity model
glm.svylogit <- svyglm(resp ~ as.factor(CENREG) + as.factor(STRAT_P) +  as.factor(INTV_MON), 
                       family = binomial(link="logit"), 
                       design = wt.dsn2)

summary(glm.svylogit)

#Predicted logit values
dat$l.hat.svylogit <- glm.svylogit$linear.predictors
#Predicted probabilities
dat$pred.svylogit <- exp(dat$l.hat.svylogit)/ (1+ exp(dat$l.hat.svylogit))
#Nonresponse adjustment 
dat$nors.adj <- 1/dat$pred.svylogit

#Add unknown eligibility weights to main dat file
dat$WT_Eligible <-case_when(
  dat$CENREG==1&!dat$OUTCOME=="Unknown Eligible"~dat$WTIA_PD*w1,
  dat$CENREG==2&!dat$OUTCOME=="Unknown Eligible"~dat$WTIA_PD*w2,
  dat$CENREG==3&!dat$OUTCOME=="Unknown Eligible"~dat$WTIA_PD*w3,
  dat$CENREG==4&!dat$OUTCOME=="Unknown Eligible"~dat$WTIA_PD*w4,
  dat$OUTCOME=="Unknown Eligible"~dat$WTIA_PD*0,
  TRUE~as.numeric(NA))

#Nonresponse adjusted weight
dat$nors.wt <-case_when(
  dat$OUTCOME1==201~dat$WT_Eligible*dat$nors.adj,
  TRUE~0)

```

```{r}

resp.dat <- dat %>%
  filter(OUTCOME1==201)

nors.dat <- dat %>%
  filter(OUTCOME1==213|OUTCOME1==215|OUTCOME1==217|OUTCOME1==218|OUTCOME1==219)

#Predicted probabilities: Respondents
summary(resp.dat$pred.svylogit)
#Predicted probabilities: Nonrespondents
summary(nors.dat$pred.svylogit)

```
Descriptive statistics for the propensity scores of respondents and nonrespondents are shown above, with the respondents shown on top and the nonrespondents shown below. The minimum and maximum values are the same for respondents and nonrespondents, but the values skew larger for respondents than nonrespondents. The median and mean values are larger for the respondents (mean=.5353) than nonrespondents (mean=.5124).

# Q5b.
```{r include = FALSE}
unk.wt.sum <- sum(dat$WT_Eligible)
nors.wt.sum <- sum(dat$nors.wt)

unk.wt.sum; nors.wt.sum

```
The sum of the unknown eligibility adjusted weights is 127,454,588, while the sum of the nonresponse adjusted weights is 132,293,164. The sum of the weights with the unknown eligibility adjustment and with the nonrseponse adjustment should be approximately the same, because in each case, the weights for the cases that are dropped out at that stage are reapplied to the other cases that are included in the adjustment. The unknown eligibility weight redistributes the weights for the unknown eligibility cases to the the known eligibility cases, and the nonresponse weight redistributes the weights for the nonresponding cases to the responding cases.  

# Q5c.
```{r echo = FALSE}
resp.dat <- dat %>%
  filter(OUTCOME1==201)

resp.dat%>%ggplot(aes(WT_Eligible,nors.wt))+
  geom_point()+
    labs(x="Unknown Eligibility Adjusted Weight (Respondents Only)",
   y="Nonresponse Adjusted Weight (Respondents Only)")
```

# Q6. 

```{r results='hide'}

#without weights
unwt.mean <- mean(dat$CTSTAT3, na.rm=T)

#base weights
wt.dsn <- svydesign(ids = ~PSU_P, strata = ~STRAT_P, weights = ~WTIA_PD, data = dat, nest = TRUE)
basewt.mean <- svymean(~CTSTAT3, wt.dsn, na.rm=TRUE)

#UNK weights
wt.dsn2 <- svydesign(ids = ~PSU_P, strata = ~STRAT_P, weights = ~WT_Eligible, data = dat, nest = TRUE)
unkwt.mean <- svymean(~CTSTAT3, wt.dsn2, na.rm=TRUE)

#Nonrespnse weights
wt.dsn3 <- svydesign(ids = ~PSU_P, strata = ~STRAT_P, weights = ~nors.wt, data = dat, nest = TRUE)
norswt.mean <- svymean(~CTSTAT3, wt.dsn3, na.rm=TRUE)

unwt.mean; basewt.mean; unkwt.mean; norswt.mean

```

Unweighted mean: 2.946632

Base weighted mean: 2.9382

Unknown eligibility weighted mean: 2.7501

Nonresponse weighted mean: 1.9219