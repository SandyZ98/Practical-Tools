---
title: "SURVMETH 745 HW9"
author: "Stacey Frank & Chendi Zhao"
date: "4/12/2022"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include=FALSE}

library(PracTools)
library(tidyverse)
library(rpart)
library(rpart.plot)

```

```{r include=FALSE}

data(nhis)

names(nhis)
dim(nhis)

```
# 13.9

```{r results='hide'}

set.seed(15097)

cart1 <- rpart(resp ~ age + sex + hisp + race + parents + educ, 
               method = "class", 
               control = rpart.control(minbucket = 50, cp = 0), 
               data = nhis)

print(cart1, digits = 4)

table(cart1$where)
```
This CART classification tree has nine terminal nodes. The first node is classified as all of those respondents and nonrespondents who have a GED or more education. The eight other nodes come from among the group that have less than a GED.The next split in the tree is between those who are aged 56 or older, and those younger than age 56. Of those who are younger than age 56, the tree divides those cases into three terminal nodes. Selected persons who do not have a parent in the family are put into one category. Of those who do have a parent present in the family, they are divided into two terminal nodes, one of people who are aged 33 or older, and those who are younger than 33. 

Of those people who are aged 56 or older and have less than a GED education, those are divided into five terminal nodes. The first is those are Hispanic. Of those who are non-Hispanic, those who are aged 82 or older are divided into their own terminal node. For non-Hispanics who are between age 56 and 81, they are divided based on education again. Of those who have an education level of some high school education or more, they are divided on age, with cases who are aged 56-60 divided into one node and those who are aged 61-81 being divided into another node. The last node is those between the ages of 56 and 81 who have an education level of 8th grade or less. A visual representation of the classification tree is below.

```{r echo = FALSE}

cols <- ifelse(cart1$frame$yval == 1, "gray50", "black")

prp(cart1, main = "Tree for NR adjustment classes in NHIS", 
    extra=106, 
    nn=TRUE,
    fallen.leaves=TRUE,
    branch=.5,
    faclen=0, 
    trace=1, 
    shadow.col="gray",
    branch.lty=1,
    branch.type=5,
    split.cex=1.2,
    split.prefix="is ",
    split.suffix="?", 
    col=cols, border.col=cols,
    split.box.col="lightgray",
    split.border.col="darkgray",
    split.round=0.5)

```
```{r results='hide'}
#unweighted response rate by node

unwt.rr <- by (as.numeric(nhis[, "resp"]), cart1$where, mean)

unwt.rr
```
The unweighted response rates in each of the nine nodes that are formed are: 1) 50%, 2) 51%, 3) 48%, 4) 64%, 5) 66%, 6) 46%, 7) 64%, 8) 69%, and 9) 73%.

# 13.10
##a.Using classes identified from 13.9
```{r}
nhis.NR <- cbind(nhis, NR.class=cart1$where)
table(nhis.NR$NR.class, useNA="always")
```

##Alternative3 Unweighted response rate
```{r}
alt3a=by(as.numeric(nhis[, "resp"]), nhis.NR$NR.class, mean)
```
##Alternative4 Weighted response rate
```{r}
alt4a=by(data = data.frame(resp = as.numeric(nhis[,"resp"]),
wt = nhis[,"svywt"]),
 nhis.NR$NR.class,
function(x) {weighted.mean(x$resp, x$wt)})
```


##b. Using classes identified from alternative 1
```{r}
p.class <- pclass(formula = resp~age +
as.factor(hisp) +
as.factor(race) +
as.factor(parents_r) +
as.factor(educ_r),
type = "unwtd", data = nhis, link="logit", numcl=5)
table(p.class$p.class, useNA="always")
```

##Alternative3 Unweighted response rate
```{r}
alt3b=by(as.numeric(nhis[, "resp"]), p.class$p.class, mean)
```
##Alternative4 Weighted response rate
```{r}
alt4b=by(data = data.frame(resp = as.numeric(nhis[,"resp"]),
wt = nhis[,"svywt"]),
 p.class$p.class,
function(x) {weighted.mean(x$resp, x$wt)})
```

## Result
```{r}
cbind(alt3a,alt4a)
cbind(alt3b,alt4b)
```

"Alt3a" and "Alt4a" were formed using nince classes identified from Exercise 13.9."Alt3a" and "Alt4a" were formed using fiveclasses identified from Alternative1 in Example 13.8.

Both alternatives produced similiar weights under the two scenarios. In practice, we need to consider the survey design when selecting the weigts to use. Ff every unit in a class has the same probability of responding, i.e., the grouping is very effective,alternative 3 is preferred.
Alternative 4 is an estimate of the population response rate in class c assuming MAR. This estimate is approximately unbiased with respect to the compound sampling/response mechanism or with respect to a model with a common response probability within each class.This choice can be inefficient if weights vary much within class and units have a common propensity score for unit i.

Five classes are usually recommended based on some analyses in Cochran (1968). With a large sample, there is no reason not to create more classes. This can help make each more homogeneous on covariates and propensity scores.More classes may decrease bias due to nonresponse but may increase variances by creating bigger spread in the weights.
